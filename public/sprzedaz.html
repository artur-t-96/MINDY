<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprzeda≈º - INFRON | InfraMinds</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #ff6b35;
            --primary-dark: #e55a2b;
            --bg: #0a0a0f;
            --card-bg: rgba(255,255,255,0.03);
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .logo a { color: inherit; text-decoration: none; }
        .nav-links a { color: #888; text-decoration: none; margin-left: 20px; }
        .nav-links a:hover { color: #fff; }
        
        .week-selector { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
        .week-selector select, .week-selector button {
            padding: 10px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
            background: var(--card-bg); color: #fff; cursor: pointer;
        }
        .week-selector button { background: var(--primary); color: #000; font-weight: 600; }
        
        .robot-section { display: flex; justify-content: center; margin-bottom: 30px; }
        .robot-card {
            background: var(--card-bg); border-radius: 20px; padding: 30px 50px;
            text-align: center; border: 2px solid var(--primary);
        }
        .robot-container { width: 150px; height: 150px; margin: 0 auto 15px; }
        .robot-name { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .robot-mood { font-size: 1rem; color: #888; margin-top: 8px; }
        .help-btn {
            margin-top: 15px; padding: 10px 24px; background: var(--primary);
            color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        @media (max-width: 800px) { .kpi-grid { grid-template-columns: 1fr; } }
        .kpi-card { background: var(--card-bg); border-radius: 12px; padding: 20px; text-align: center; }
        .kpi-label { font-size: 0.8rem; color: #888; margin-bottom: 8px; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .kpi-target { font-size: 0.75rem; color: #555; margin-top: 4px; }
        .kpi-percent { font-size: 0.9rem; margin-top: 8px; padding: 4px 10px; border-radius: 20px; display: inline-block; }
        .kpi-percent.good { background: rgba(255,107,53,0.2); color: #ff6b35; }
        .kpi-percent.warn { background: rgba(255,200,0,0.2); color: #ffc800; }
        .kpi-percent.bad { background: rgba(255,80,80,0.2); color: #ff5050; }
        
        .tables-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 1000px) { .tables-section { grid-template-columns: 1fr; } }
        .table-card { background: var(--card-bg); border-radius: 16px; padding: 20px; overflow-x: auto; }
        .table-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--primary); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .data-table th { color: #888; font-weight: 500; font-size: 0.85rem; }
        .rank-badge { display: inline-flex; width: 28px; height: 28px; align-items: center; justify-content: center; border-radius: 50%; font-weight: 600; font-size: 0.85rem; }
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff; }
        .rank-other { background: rgba(255,255,255,0.1); color: #666; }
        .stanowisko-badge { background: rgba(255,107,53,0.15); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; }
        .mrr-value { color: var(--primary); font-weight: 700; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.3rem; font-weight: 600; color: var(--primary); }
        .modal-close { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }
        
        footer { text-align: center; padding: 30px; color: #555; }
        footer a { color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo"><a href="/">‚Üê InfraMinds</a> / Sprzeda≈º</div>
            <div class="nav-links">
                <a href="/body-leasing">Body Leasing</a>
                <a href="/rada-nadzorcza">Rada Nadzorcza</a>
                <a href="/admin">Admin</a>
            </div>
        </header>
        
        <div class="week-selector">
            <select id="weekSelect"></select>
            <button onclick="loadData()">Od≈õwie≈º</button>
        </div>
        
        <div class="robot-section">
            <div class="robot-card">
                <div class="robot-container" id="robotContainer"></div>
                <div class="robot-name">INFRON</div>
                <div class="robot-mood" id="robotMood">≈Åadujƒô...</div>
                <button class="help-btn" onclick="showHelp()">üí¨ Jak mogƒô pom√≥c?</button>
            </div>
        </div>
        
        <div class="kpi-grid" id="kpiGrid"></div>
        
        <div class="tables-section">
            <div class="table-card">
                <div class="table-title">üí∞ Ranking ‚Äî Tydzie≈Ñ <span id="weekLabel"></span></div>
                <table class="data-table" id="tableWeek">
                    <thead>
                        <tr><th>#</th><th>Imiƒô</th><th>Rola</th><th>üíé MRR</th><th>Oferty</th><th>Leady</th><th>Dni</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="table-card">
                <div class="table-title">üìä Ranking Average (per dzie≈Ñ/tydzie≈Ñ)</div>
                <table class="data-table" id="tableAvg">
                    <thead>
                        <tr><th>#</th><th>Imiƒô</th><th>Rola</th><th>MRR/tyg</th><th>Oferty/d</th><th>Leady/d</th><th>Tyg.</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <footer>INFRON ¬© InfraMinds 2025 | <a href="/admin">Panel Admin</a></footer>
    </div>
    
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üí¨ INFRON</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-content" id="helpContent">≈Åadujƒô...</div>
        </div>
    </div>
    
    <script>
        let currentData = null;
        
        function createRobot(container, percent) {
            const color = percent >= 85 ? '#ff6b35' : percent >= 70 ? '#ffc800' : '#ff5050';
            const mood = getMood(percent);
            
            container.innerHTML = `
                <svg viewBox="0 0 120 140" width="150" height="170">
                    <defs><filter id="glow"><feGaussianBlur stdDeviation="3"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
                    <rect x="20" y="55" width="80" height="65" rx="15" fill="${color}" opacity="0.9" filter="url(#glow)"/>
                    <rect x="30" y="20" width="60" height="50" rx="12" fill="${color}"/>
                    <rect x="38" y="34" width="16" height="10" rx="3" fill="#0a0a0f"/>
                    <rect x="66" y="34" width="16" height="10" rx="3" fill="#0a0a0f"/>
                    ${mood.eyes}
                    ${mood.mouth}
                    <rect x="56" y="5" width="8" height="18" rx="4" fill="${color}"/>
                    <circle cx="60" cy="5" r="6" fill="${percent >= 100 ? '#ff9500' : color}"/>
                    <rect x="5" y="70" width="18" height="12" rx="6" fill="${color}"/>
                    <rect x="97" y="70" width="18" height="12" rx="6" fill="${color}"/>
                </svg>
            `;
        }
        
        function getMood(percent) {
            if (percent >= 100) return { emoji: 'ü§©', text: 'Rewelacyjna sprzeda≈º!', eyes: '<rect x="40" y="36" width="6" height="6" fill="#fff"/><rect x="74" y="36" width="6" height="6" fill="#fff"/>', mouth: '<path d="M45 52 Q60 65 75 52" stroke="#0a0a0f" stroke-width="4" fill="none"/>' };
            if (percent >= 85) return { emoji: 'üòä', text: '≈öwietne wyniki!', eyes: '<rect x="40" y="36" width="6" height="6" fill="#fff"/><rect x="74" y="36" width="6" height="6" fill="#fff"/>', mouth: '<rect x="48" y="52" width="24" height="5" rx="2" fill="#0a0a0f"/>' };
            if (percent >= 70) return { emoji: 'üòê', text: 'Mo≈ºe byƒá lepiej...', eyes: '<rect x="40" y="38" width="6" height="4" fill="#fff"/><rect x="74" y="38" width="6" height="4" fill="#fff"/>', mouth: '<rect x="50" y="54" width="20" height="4" rx="2" fill="#0a0a0f"/>' };
            return { emoji: 'üòü', text: 'Potrzebujemy akcji!', eyes: '<rect x="40" y="38" width="6" height="4" fill="#fff"/><rect x="74" y="38" width="6" height="4" fill="#fff"/>', mouth: '<path d="M50 58 Q60 52 70 58" stroke="#0a0a0f" stroke-width="3" fill="none"/>' };
        }
        
        async function loadData() {
            const select = document.getElementById('weekSelect');
            const [rok, tydzien] = select.value.split('-');
            
            const res = await fetch(`/api/sprzedaz?rok=${rok}&tydzien=${tydzien}`);
            currentData = await res.json();
            
            document.getElementById('weekLabel').textContent = currentData.tydzien;
            
            const data = currentData.current.sprzedaz;
            const tt = currentData.teamTargets;
            const totals = {
                leady: data.reduce((s, r) => s + (r.leady || 0), 0),
                oferty: data.reduce((s, r) => s + (r.oferty || 0), 0),
                mrr: data.reduce((s, r) => s + (r.mrr || 0), 0)
            };
            
            const percents = [];
            if (tt.mrr > 0) percents.push(totals.mrr / tt.mrr * 100);
            if (tt.oferty > 0) percents.push(totals.oferty / tt.oferty * 100);
            if (tt.leady > 0) percents.push(totals.leady / tt.leady * 100);
            const overallPercent = percents.length > 0 ? percents.reduce((a, b) => a + b) / percents.length : 0;
            
            createRobot(document.getElementById('robotContainer'), overallPercent);
            const mood = getMood(overallPercent);
            document.getElementById('robotMood').innerHTML = `${mood.emoji} ${mood.text}<br><small style="color:#666">${Math.round(overallPercent)}% targetu</small>`;
            
            document.getElementById('kpiGrid').innerHTML = `
                ${kpiCard('üíé MRR', totals.mrr.toLocaleString() + ' z≈Ç', tt.mrr.toLocaleString() + ' z≈Ç', totals.mrr, tt.mrr)}
                ${kpiCard('Wys≈Çane Oferty', totals.oferty, tt.oferty, totals.oferty, tt.oferty)}
                ${kpiCard('Leady', totals.leady, tt.leady, totals.leady, tt.leady)}
            `;
            
            renderWeekTable(data);
            renderAvgTable(currentData.average);
        }
        
        function kpiCard(label, value, target, numVal, numTarget) {
            const pct = numTarget > 0 ? Math.round(numVal / numTarget * 100) : 0;
            const cls = pct >= 100 ? 'good' : pct >= 70 ? 'warn' : 'bad';
            return `
                <div class="kpi-card">
                    <div class="kpi-label">${label}</div>
                    <div class="kpi-value">${value}</div>
                    <div class="kpi-target">Target: ${target}</div>
                    <div class="kpi-percent ${cls}">${pct}%</div>
                </div>
            `;
        }
        
        function renderWeekTable(data) {
            const sorted = [...data].sort((a, b) => {
                if ((b.mrr || 0) !== (a.mrr || 0)) return (b.mrr || 0) - (a.mrr || 0);
                if ((b.oferty || 0) !== (a.oferty || 0)) return (b.oferty || 0) - (a.oferty || 0);
                return (b.leady || 0) - (a.leady || 0);
            });
            
            const tbody = document.querySelector('#tableWeek tbody');
            tbody.innerHTML = sorted.length === 0 ? '<tr><td colspan="7" style="text-align:center;color:#666;">Brak danych</td></tr>' : sorted.map((r, i) => `
                <tr>
                    <td><span class="rank-badge ${i < 3 ? 'rank-' + (i + 1) : 'rank-other'}">${i + 1}</span></td>
                    <td><strong>${r.imie}</strong></td>
                    <td><span class="stanowisko-badge">${r.stanowisko}</span></td>
                    <td class="mrr-value">${r.mrr ? r.mrr.toLocaleString() + ' z≈Ç' : '-'}</td>
                    <td>${r.oferty || '-'}</td>
                    <td>${r.leady || '-'}</td>
                    <td style="color:#666">${r.dni_pracy || 5}</td>
                </tr>
            `).join('');
        }
        
        function renderAvgTable(data) {
            const tbody = document.querySelector('#tableAvg tbody');
            tbody.innerHTML = data.length === 0 ? '<tr><td colspan="7" style="text-align:center;color:#666;">Brak danych</td></tr>' : data.map((r, i) => `
                <tr>
                    <td><span class="rank-badge ${i < 3 ? 'rank-' + (i + 1) : 'rank-other'}">${i + 1}</span></td>
                    <td><strong>${r.imie}</strong></td>
                    <td><span class="stanowisko-badge">${r.stanowisko}</span></td>
                    <td class="mrr-value">${r.mrr_per_week ? Math.round(r.mrr_per_week).toLocaleString() + ' z≈Ç' : '-'}</td>
                    <td>${r.oferty_per_day || '-'}</td>
                    <td>${r.leady_per_day || '-'}</td>
                    <td style="color:#666">${r.tygodni || 0}</td>
                </tr>
            `).join('');
        }
        
        async function showHelp() {
            document.getElementById('helpModal').classList.add('active');
            document.getElementById('helpContent').innerHTML = '<div style="text-align:center;color:#888;">‚è≥ My≈õlƒô...</div>';
            
            const res = await fetch('/api/help/sprzedaz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rok: currentData.rok, tydzien: currentData.tydzien })
            });
            const data = await res.json();
            document.getElementById('helpContent').innerHTML = data.help || data.error || 'Brak odpowiedzi';
        }
        
        function closeModal() { document.getElementById('helpModal').classList.remove('active'); }
        
        async function init() {
            const res = await fetch('/api/sprzedaz');
            const data = await res.json();
            
            const select = document.getElementById('weekSelect');
            data.weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = `${w.rok}-${w.tydzien}`;
                opt.textContent = `Tydzie≈Ñ ${w.tydzien}/${w.rok}`;
                if (w.rok === data.rok && w.tydzien === data.tydzien) opt.selected = true;
                select.appendChild(opt);
            });
            if (data.weeks.length === 0) {
                const opt = document.createElement('option');
                opt.value = `${data.rok}-${data.tydzien}`;
                opt.textContent = `Tydzie≈Ñ ${data.tydzien}/${data.rok}`;
                select.appendChild(opt);
            }
            loadData();
        }
        init();
    </script>
</body>
</html>
